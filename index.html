<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إصدار التقرير الطبي - التصميم الجديد</title>
    <script src="https://unpkg.com/docx@7.8.2/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        body { font-family: 'Arial', Tahoma, sans-serif; background-color: #f4f7f9; padding: 15px; direction: rtl; }
        .container { background-color: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 850px; margin: auto; }
        h2 { text-align: center; color: #1D5C96; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; font-weight: bold; }
        .section-title { background: #1D5C96; color: white; padding: 8px 15px; border-radius: 6px; margin: 20px 0 15px 0; font-weight: bold; }
        .row { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px; }
        .col { flex: 1; min-width: 200px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; font-size: 14px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; box-sizing: border-box; font-family: 'Arial'; }
        input[readonly] { background-color: #e9ecef; color: #555; }
        button { width: 100%; padding: 18px; background-color: #28a745; color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 25px; transition: 0.3s; }
        button:hover { background-color: #218838; }
    </style>
</head>
<body>

<div class="container">
    <h2>واجهة تجهيز التقرير (مطابق للتحديث الجديد)</h2>

    <div class="section-title">التواريخ والمدة</div>
    <div class="row">
        <div class="col"><label>رمز الإجازة (Leave ID):</label><input type="text" id="leaveId" value="PSL25102614679"></div>
        <div class="col"><label>تاريخ إصدار التقرير:</label><input type="date" id="issueDate"></div>
    </div>
    <div class="row">
        <div class="col"><label>تاريخ الدخول:</label><input type="date" id="startDate" oninput="calcDate()"></div>
        <div class="col"><label>المدة (بالأيام):</label><input type="number" id="durationDays" min="1" oninput="calcDate()"></div>
        <div class="col"><label>تاريخ الخروج (تلقائي):</label><input type="text" id="endDate" readonly></div>
    </div>

    <div class="section-title">بيانات المريض</div>
    <div class="row">
        <div class="col"><label>الاسم (عربي):</label><input type="text" id="nameAr"></div>
        <div class="col"><label>الاسم (إنجليزي):</label><input type="text" id="nameEn" oninput="this.value = this.value.toUpperCase()"></div>
    </div>
    <div class="row">
        <div class="col"><label>رقم الهوية / الإقامة:</label><input type="text" id="nationalId"></div>
        <div class="col">
            <label>الجنسية:</label>
            <select id="nationalityAr" oninput="syncData('nationalityAr', 'nationalityEn')">
                <option value="" data-en="" selected>اختر...</option>
                <option value="السعودية" data-en="Saudi Arabia">السعودية</option>
                <option value="اليمن" data-en="Yemen">اليمن</option>
                <option value="المصرية" data-en="Egyptian">المصرية</option>
            </select>
        </div>
        <div class="col"><label>Nationality:</label><input type="text" id="nationalityEn" readonly></div>
    </div>

    <div class="section-title">جهة العمل والممارس</div>
    <div class="row">
        <div class="col"><label>جهة العمل (عربي):</label><input type="text" id="employerAr" value="طالب"></div>
        <div class="col"><label>Employer (English):</label><input type="text" id="employerEn"></div>
    </div>
    <div class="row">
        <div class="col"><label>اسم الممارس (عربي):</label><input type="text" id="doctorAr"></div>
        <div class="col"><label>Practitioner Name:</label><input type="text" id="doctorEn" oninput="this.value = this.value.toUpperCase()"></div>
    </div>
    <div class="row">
        <div class="col">
            <label>المسمى الوظيفي:</label>
            <select id="positionAr" oninput="syncData('positionAr', 'positionEn')">
                <option value="" data-en="" selected>اختر...</option>
                <option value="طبيب عام" data-en="General">طبيب عام</option>
                <option value="استشاري" data-en="Consultant">استشاري</option>
            </select>
        </div>
        <div class="col"><label>Position:</label><input type="text" id="positionEn" readonly></div>
    </div>

    <div class="section-title">المرفقات والشعارات</div>
    <div class="row">
        <div class="col"><label>شعار صحة (أعلى اليسار):</label><input type="file" id="imgSeha" accept="image/*"></div>
        <div class="col"><label>الباركود (أسفل اليسار):</label><input type="file" id="imgBarcode" accept="image/*"></div>
    </div>
    <div class="row">
        <div class="col"><label>شعار المستشفى (أسفل اليمين):</label><input type="file" id="imgHospital" accept="image/*"></div>
        <div class="col"><label>شعار المركز الوطني (أسفل):</label><input type="file" id="imgNhic" accept="image/*"></div>
    </div>

    <button onclick="generateWord()">إصدار وتحميل التقرير فوراً</button>
</div>

<script>
    function calcDate() {
        const startVal = document.getElementById("startDate").value;
        const daysVal = document.getElementById("durationDays").value;
        if (startVal && daysVal) {
            const days = parseInt(daysVal);
            if (!isNaN(days) && days > 0) {
                let d = new Date(startVal);
                d.setDate(d.getDate() + (days - 1));
                document.getElementById("endDate").value = d.toISOString().split('T')[0];
                return;
            }
        }
        document.getElementById("endDate").value = "";
    }

    function syncData(arId, enId) {
        const sel = document.getElementById(arId);
        const selectedOpt = sel.options[sel.selectedIndex];
        if(selectedOpt) document.getElementById(enId).value = selectedOpt.getAttribute('data-en') || "";
    }

    function readFile(id) {
        return new Promise((resolve) => {
            const file = document.getElementById(id).files[0];
            if (!file) { resolve(null); return; }
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.readAsArrayBuffer(file);
        });
    }

    function formatDateToSaudi(dateStr) {
        if (!dateStr) return "-";
        const parts = dateStr.split('-');
        if (parts.length === 3) return `${parts[2]}-${parts[1]}-${parts[0]}`;
        return dateStr;
    }

    // بناء خلية الجدول بالألوان الجديدة
    function createCell(text, align, bgColor, textColor, isBold) {
        return new docx.TableCell({
            shading: { fill: bgColor },
            margins: { top: 120, bottom: 120, left: 100, right: 100 },
            verticalAlign: docx.VerticalAlign.CENTER,
            children: [
                new docx.Paragraph({
                    alignment: align,
                    children: [ new docx.TextRun({ text: text || "", color: textColor, bold: isBold, size: 20, font: "Arial" }) ]
                })
            ]
        });
    }

    // صف يدمج الخانتين في المنتصف (مثل رمز الإجازة ورقم الهوية)
    function createMergedRow(lblEn, val, lblAr) {
        return new docx.TableRow({
            children: [
                createCell(lblEn, docx.AlignmentType.CENTER, "FFFFFF", "1D5C96", true),
                new docx.TableCell({
                    columnSpan: 2, shading: { fill: "FFFFFF" }, verticalAlign: docx.VerticalAlign.CENTER,
                    children: [ new docx.Paragraph({ alignment: docx.AlignmentType.CENTER, children: [ new docx.TextRun({ text: val || "-", color: "333333", size: 20, font: "Arial" }) ] }) ]
                }),
                createCell(lblAr, docx.AlignmentType.CENTER, "FFFFFF", "1D5C96", true)
            ]
        });
    }

    // صف مقسم لـ 4 خلايا (عناوين وقيمتين) - يدعم التلوين للصف الداكن
    function createSplitRow(lblEn, valEn, valAr, lblAr, isDark = false) {
        const bg = isDark ? "233B65" : "FFFFFF"; // اللون الكحلي المطابق للتصميم الجديد
        const lblTxt = isDark ? "FFFFFF" : "1D5C96";
        const valTxt = isDark ? "FFFFFF" : "333333";
        return new docx.TableRow({
            children: [
                createCell(lblEn, docx.AlignmentType.CENTER, bg, lblTxt, true),
                createCell(valEn, docx.AlignmentType.CENTER, bg, valTxt, false),
                createCell(valAr, docx.AlignmentType.CENTER, bg, valTxt, false),
                createCell(lblAr, docx.AlignmentType.CENTER, bg, lblTxt, true)
            ]
        });
    }

    async function generateWord() {
        try {
            const v = {
                id: document.getElementById("leaveId").value,
                dur: document.getElementById("durationDays").value,
                st: formatDateToSaudi(document.getElementById("startDate").value),
                en: formatDateToSaudi(document.getElementById("endDate").value),
                iss: formatDateToSaudi(document.getElementById("issueDate").value),
                nAr: document.getElementById("nameAr").value,
                nEn: document.getElementById("nameEn").value,
                natId: document.getElementById("nationalId").value,
                natAr: document.getElementById("nationalityAr").value,
                natEn: document.getElementById("nationalityEn").value,
                empAr: document.getElementById("employerAr").value,
                empEn: document.getElementById("employerEn").value,
                docAr: document.getElementById("doctorAr").value,
                docEn: document.getElementById("doctorEn").value,
                posAr: document.getElementById("positionAr").value,
                posEn: document.getElementById("positionEn").value
            };

            const imgNhic = await readFile("imgNhic");
            const imgHospital = await readFile("imgHospital");
            const imgBarcode = await readFile("imgBarcode");
            const imgSeha = await readFile("imgSeha");

            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }); 
            const dateStr = now.toLocaleDateString('en-US', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });

            // لون الحدود الفاتح جداً كما في الصورة
            const borderStyle = { style: docx.BorderStyle.SINGLE, size: 2, color: "D0D8E0" };

            let durationTextEn = "";
            let durationTextAr = "";
            if (v.dur && v.st && v.en) {
                durationTextEn = `${v.dur} day ( ${v.st} to ${v.en} )`;
                durationTextAr = `${v.dur} يوم ( ${v.st} إلى ${v.en} )`;
            }

            const doc = new docx.Document({
                sections: [{
                    properties: {},
                    headers: {
                        default: new docx.Header({
                            children: [
                                new docx.Paragraph({
                                    alignment: docx.AlignmentType.LEFT,
                                    children: imgSeha ? [new docx.ImageRun({ data: imgSeha, transformation: { width: 100, height: 40 } })] : []
                                })
                            ]
                        })
                    },
                    children: [
                        new docx.Paragraph({ alignment: docx.AlignmentType.CENTER, children: [new docx.TextRun({ text: "تقرير إجازة مرضية", bold: true, size: 36, color: "1D5C96", font: "Arial" })] }),
                        new docx.Paragraph({ alignment: docx.AlignmentType.CENTER, children: [new docx.TextRun({ text: "Sick Leave Report", bold: true, size: 24, color: "1D5C96", font: "Arial" })] }),
                        new docx.Paragraph({ text: "" }), 

                        // الجدول الرئيسي المحدث بـ 4 أعمدة
                        new docx.Table({
                            width: { size: 100, type: docx.WidthType.PERCENTAGE },
                            borders: { top: borderStyle, bottom: borderStyle, left: borderStyle, right: borderStyle, insideHorizontal: borderStyle, insideVertical: borderStyle },
                            columnWidths: [20, 30, 30, 20], // نسب عرض الأعمدة التقريبية
                            rows: [
                                createMergedRow("Leave ID", v.id, "رمز الإجازة"),
                                createSplitRow("Leave Duration", durationTextEn, durationTextAr, "مدة الإجازة", true), // الصف الداكن
                                createSplitRow("Admission Date", v.st, v.st, "تاريخ الدخول"),
                                createSplitRow("Discharge Date", v.en, v.en, "تاريخ الخروج"),
                                createMergedRow("Issue Date", v.iss, "تاريخ إصدار التقرير"),
                                createSplitRow("Name", v.nEn, v.nAr, "الاسم"),
                                createMergedRow("National ID / Iqama", v.natId, "رقم الهوية / الإقامة"),
                                createSplitRow("Nationality", v.natEn, v.natAr, "الجنسية"),
                                createSplitRow("Employer", v.empEn, v.empAr, "جهة العمل"),
                                createSplitRow("Practitioner Name", v.docEn, v.docAr, "اسم الممارس"),
                                createSplitRow("Position", v.posEn, v.posAr, "المسمى الوظيفي")
                            ]
                        }),

                        new docx.Paragraph({ text: "" }),
                        new docx.Paragraph({ text: "" }),

                        // تذييل الصفحة مقسم كالصورة تماماً
                        new docx.Table({
                            width: { size: 100, type: docx.WidthType.PERCENTAGE },
                            borders: { top: {style:"none"}, bottom: {style:"none"}, left: {style:"none"}, right: {style:"none"}, insideVertical: {style:"none"}, insideHorizontal: {style:"none"} },
                            rows: [
                                new docx.TableRow({
                                    children: [
                                        // الخلية اليسرى (الباركود والتاريخ)
                                        new docx.TableCell({
                                            width: { size: 50, type: docx.WidthType.PERCENTAGE },
                                            verticalAlign: docx.VerticalAlign.BOTTOM,
                                            children: [
                                                new docx.Paragraph({ alignment: docx.AlignmentType.CENTER, children: imgBarcode ? [new docx.ImageRun({ data: imgBarcode, transformation: { width: 90, height: 90 } })] : [] }),
                                                new docx.Paragraph({ text: "" }),
                                                new docx.Paragraph({ alignment: docx.AlignmentType.CENTER, children: [new docx.TextRun({ text: "للتحقق من بيانات التقرير يرجى التأكد من زيارة موقع منصة صحة الرسمي", bold: true, size: 14, font: "Arial" })] }),
                                                new docx.Paragraph({ alignment: docx.AlignmentType.CENTER, children: [new docx.TextRun({ text: "To check the report please visit Seha's offical website", bold: true, size: 14, font: "Arial" })] }),
                                                new docx.Paragraph({ alignment: docx.AlignmentType.CENTER, children: [new docx.TextRun({ text: "www.seha.sa/#/inquiries/slenquiry", color: "0000FF", underline: {}, bold: true, size: 14, font: "Arial" })] }),
                                                new docx.Paragraph({ text: "" }),
                                                new docx.Paragraph({ alignment: docx.AlignmentType.LEFT, children: [new docx.TextRun({ text: timeStr, bold: true, size: 16, font: "Arial" })] }),
                                                new docx.Paragraph({ alignment: docx.AlignmentType.LEFT, children: [new docx.TextRun({ text: dateStr, bold: true, size: 16, font: "Arial" })] })
                                            ]
                                        }),
                                        // الخلية اليمنى (الشعارات)
                                        new docx.TableCell({
                                            width: { size: 50, type: docx.WidthType.PERCENTAGE },
                                            verticalAlign: docx.VerticalAlign.BOTTOM,
                                            children: [
                                                new docx.Paragraph({ alignment: docx.AlignmentType.CENTER, children: imgHospital ? [new docx.ImageRun({ data: imgHospital, transformation: { width: 140, height: 100 } })] : [] }),
                                                new docx.Paragraph({ text: "" }),
                                                new docx.Paragraph({ text: "" }),
                                                new docx.Paragraph({ text: "" }),
                                                new docx.Paragraph({ alignment: docx.AlignmentType.RIGHT, children: imgNhic ? [new docx.ImageRun({ data: imgNhic, transformation: { width: 120, height: 60 } })] : [] })
                                            ]
                                        })
                                    ]
                                })
                            ]
                        })
                    ]
                }]
            });

            docx.Packer.toBlob(doc).then((blob) => {
                saveAs(blob, "Sick_Leave_Report_V2.docx");
            }).catch(e => alert("حدث خطأ في التجهيز: " + e.message));
        } catch (error) {
            alert("حدث خطأ غير متوقع: " + error.message);
        }
    }
</script>
</body>
</html>
