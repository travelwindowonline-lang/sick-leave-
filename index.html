<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إصدار التقرير الطبي</title>
    <script src="https://unpkg.com/docx@7.8.2/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Arial, sans-serif; background-color: #f4f7f9; padding: 15px; direction: rtl; }
        .container { background-color: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 850px; margin: auto; }
        h2 { text-align: center; color: #1D5C96; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .section-title { background: #1D5C96; color: white; padding: 8px 15px; border-radius: 6px; margin: 20px 0 15px 0; font-weight: bold; }
        .row { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px; }
        .col { flex: 1; min-width: 200px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; font-size: 14px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; box-sizing: border-box; }
        input[readonly] { background-color: #e9ecef; color: #555; }
        button { width: 100%; padding: 18px; background-color: #28a745; color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 25px; transition: 0.3s; }
        button:hover { background-color: #218838; }
    </style>
</head>
<body>

<div class="container">
    <h2>واجهة تجهيز التقرير (نموذج فارغ)</h2>

    <div class="section-title">التواريخ والمدة</div>
    <div class="row">
        <div class="col"><label>رمز الإجازة (Leave ID):</label><input type="text" id="leaveId"></div>
        <div class="col"><label>تاريخ إصدار التقرير:</label><input type="date" id="issueDate"></div>
    </div>
    <div class="row">
        <div class="col"><label>تاريخ الدخول:</label><input type="date" id="startDate" oninput="calcDate()"></div>
        <div class="col"><label>المدة (بالأيام):</label><input type="number" id="durationDays" min="1" oninput="calcDate()"></div>
        <div class="col"><label>تاريخ الخروج (تلقائي):</label><input type="text" id="endDate" readonly placeholder="سيظهر تلقائياً"></div>
    </div>

    <div class="section-title">بيانات المريض</div>
    <div class="row">
        <div class="col"><label>الاسم (عربي):</label><input type="text" id="nameAr"></div>
        <div class="col"><label>الاسم (إنجليزي):</label><input type="text" id="nameEn" oninput="this.value = this.value.toUpperCase()"></div>
    </div>
    <div class="row">
        <div class="col"><label>رقم الهوية / الإقامة:</label><input type="text" id="nationalId"></div>
        <div class="col">
            <label>الجنسية:</label>
            <select id="nationalityAr" oninput="syncData('nationalityAr', 'nationalityEn')">
                <option value="" data-en="" selected>اختر...</option>
                <option value="السعودية" data-en="Saudi Arabia">السعودية</option>
                <option value="المصرية" data-en="Egyptian">المصرية</option>
                <option value="السورية" data-en="Syrian">السورية</option>
            </select>
        </div>
        <div class="col"><label>Nationality (تلقائي):</label><input type="text" id="nationalityEn" readonly placeholder="سيظهر تلقائياً"></div>
    </div>

    <div class="section-title">جهة العمل والطبيب</div>
    <div class="row">
        <div class="col"><label>جهة العمل (عربي):</label><input type="text" id="employerAr"></div>
        <div class="col"><label>Employer (English):</label><input type="text" id="employerEn"></div>
    </div>
    <div class="row">
        <div class="col"><label>اسم الطبيب (عربي):</label><input type="text" id="doctorAr"></div>
        <div class="col"><label>Physician Name:</label><input type="text" id="doctorEn" oninput="this.value = this.value.toUpperCase()"></div>
    </div>
    <div class="row">
        <div class="col">
            <label>المسمى الوظيفي:</label>
            <select id="positionAr" oninput="syncData('positionAr', 'positionEn')">
                <option value="" data-en="" selected>اختر...</option>
                <option value="طبيب عام" data-en="General practitioner">طبيب عام</option>
                <option value="استشاري" data-en="Consultant">استشاري</option>
                <option value="نائب" data-en="Resident">نائب</option>
            </select>
        </div>
        <div class="col"><label>Position (تلقائي):</label><input type="text" id="positionEn" readonly placeholder="سيظهر تلقائياً"></div>
    </div>

    <div class="section-title">المرفقات (الصور والشعارات)</div>
    <div class="row">
        <div class="col"><label>شعار وزارة الصحة (أعلى اليسار):</label><input type="file" id="imgSeha" accept="image/*"></div>
        <div class="col"><label>الباركود (أسفل اليسار):</label><input type="file" id="imgBarcode" accept="image/*"></div>
    </div>
    <div class="row">
        <div class="col"><label>شعار المستشفى (أسفل اليمين):</label><input type="file" id="imgHospital" accept="image/*"></div>
        <div class="col"><label>شعار المركز الوطني (أسفل اليمين):</label><input type="file" id="imgNhic" accept="image/*"></div>
    </div>

    <button onclick="generateWord()">إصدار وتحميل التقرير فوراً</button>
</div>

<script>
    // التعبئة التلقائية للتواريخ
    function calcDate() {
        const startVal = document.getElementById("startDate").value;
        const daysVal = document.getElementById("durationDays").value;
        if (startVal && daysVal) {
            const days = parseInt(daysVal);
            if (!isNaN(days) && days > 0) {
                let d = new Date(startVal);
                d.setDate(d.getDate() + (days - 1));
                document.getElementById("endDate").value = d.toISOString().split('T')[0];
                return;
            }
        }
        document.getElementById("endDate").value = "";
    }

    // التعبئة التلقائية للغة الإنجليزية
    function syncData(arId, enId) {
        const sel = document.getElementById(arId);
        const selectedOpt = sel.options[sel.selectedIndex];
        if(selectedOpt) {
            document.getElementById(enId).value = selectedOpt.getAttribute('data-en') || "";
        }
    }

    // قراءة الصور بأمان
    function readFile(id) {
        return new Promise((resolve) => {
            const file = document.getElementById(id).files[0];
            if (!file) { resolve(null); return; }
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.readAsArrayBuffer(file);
        });
    }

    // إنشاء خلايا الجدول
    function createCell(text, align, bgColor, textColor, isLabel) {
        return new docx.TableCell({
            shading: { fill: bgColor },
            margins: { top: 120, bottom: 120, left: 100, right: 100 },
            verticalAlign: docx.VerticalAlign.CENTER,
            children: [
                new docx.Paragraph({
                    alignment: align,
                    children: [ new docx.TextRun({ text: text || "-", color: textColor, bold: true, size: 22, font: isLabel ? "Arial" : "Sakkal Majalla" }) ]
                })
            ]
        });
    }

    // صف مدمج
    function createMergedRow(lblEn, val, lblAr) {
        return new docx.TableRow({
            children: [
                createCell(lblEn, docx.AlignmentType.RIGHT, "FFFFFF", "1D5C96", true),
                new docx.TableCell({
                    columnSpan: 2, shading: { fill: "FFFFFF" }, verticalAlign: docx.VerticalAlign.CENTER,
                    children: [ new docx.Paragraph({ alignment: docx.AlignmentType.CENTER, children: [ new docx.TextRun({ text: val || "-", color: "000000", bold: true, size: 24 }) ] }) ]
                }),
                createCell(lblAr, docx.AlignmentType.RIGHT, "FFFFFF", "1D5C96", true)
            ]
        });
    }

    // صف مقسوم (لغتين)
    function createSplitRow(lblEn, valEn, valAr, lblAr, isDark) {
        const bg = isDark ? "1D5C96" : "FFFFFF";
        const txt = isDark ? "FFFFFF" : "1D5C96";
        const valTxt = isDark ? "FFFFFF" : "000000";
        return new docx.TableRow({
            children: [
                createCell(lblEn, docx.AlignmentType.RIGHT, bg, txt, true),
                createCell(valEn, docx.AlignmentType.CENTER, bg, valTxt),
                createCell(valAr, docx.AlignmentType.CENTER, bg, valTxt),
                createCell(lblAr, docx.AlignmentType.RIGHT, bg, txt, true)
            ]
        });
    }

    // دالة إنشاء الوورد الأساسية
    async function generateWord() {
        alert("جاري تجهيز الملف.. اضغط OK وسيتم التحميل فوراً.");
        
        try {
            const v = {
                id: document.getElementById("leaveId").value,
                dur: document.getElementById("durationDays").value,
                st: document.getElementById("startDate").value,
                en: document.getElementById("endDate").value,
                iss: document.getElementById("issueDate").value,
                nAr: document.getElementById("nameAr").value,
                nEn: document.getElementById("nameEn").value,
                natId: document.getElementById("nationalId").value,
                natAr: document.getElementById("nationalityAr").value,
                natEn: document.getElementById("nationalityEn").value,
                empAr: document.getElementById("employerAr").value,
                empEn: document.getElementById("employerEn").value,
                docAr: document.getElementById("doctorAr").value,
                docEn: document.getElementById("doctorEn").value,
                posAr: document.getElementById("positionAr").value,
                posEn: document.getElementById("positionEn").value
            };

            const imgSeha = await readFile("imgSeha");
            const imgBarcode = await readFile("imgBarcode");
            const imgHospital = await readFile("imgHospital");
            const imgNhic = await readFile("imgNhic");

            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true }); 
            const dateStr = now.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });

            const borderStyle = { style: docx.BorderStyle.SINGLE, size: 2, color: "1D5C96" };

            let durationTextEn = "-";
            let durationTextAr = "-";
            if (v.dur && v.st && v.en) {
                durationTextEn = `${v.dur} day(s) (${v.st} to ${v.en})`;
                durationTextAr = `يوم (${v.dur}) ${v.st} الى ${v.en}`;
            }

            const doc = new docx.Document({
                sections: [{
                    properties: {},
                    headers: {
                        default: new docx.Header({
                            children: [
                                new docx.Paragraph({
                                    children: imgSeha ? [new docx.ImageRun({ data: imgSeha, transformation: { width: 120, height: 45 } })] : [new docx.TextRun("")]
                                })
                            ]
                        })
                    },
                    children: [
                        new docx.Paragraph({ alignment: docx.AlignmentType.CENTER, children: [new docx.TextRun({ text: "تقرير إجازة مرضية", bold: true, size: 44, color: "1D5C96" })] }),
                        new docx.Paragraph({ alignment: docx.AlignmentType.CENTER, children: [new docx.TextRun({ text: "Sick Leave Report", bold: true, size: 36, color: "1D5C96" })] }),
                        new docx.Paragraph({ text: "" }), 

                        new docx.Table({
                            width: { size: 100, type: docx.WidthType.PERCENTAGE },
                            borders: { top: borderStyle, bottom: borderStyle, left: borderStyle, right: borderStyle, insideHorizontal: borderStyle, insideVertical: borderStyle },
                            rows: [
                                createMergedRow("Leave ID", v.id, "رمز الإجازة"),
                                createSplitRow("Leave Duration", durationTextEn, durationTextAr, "مدة الإجازة", true),
                                createMergedRow("Admission Date", v.st, "تاريخ الدخول"),
                                createMergedRow("Discharge Date", v.en, "تاريخ الخروج"),
                                createMergedRow("Issue Date", v.iss, "تاريخ اصدار التقرير"),
                                createSplitRow("Name", v.nEn, v.nAr, "الاسم"),
                                createMergedRow("National ID/Iqama", v.natId, "رقم الهوية / الإقامة"),
                                createSplitRow("Nationality", v.natEn, v.natAr, "الجنسية"),
                                createSplitRow("Employer", v.empEn, v.empAr, "جهة العمل"),
                                createSplitRow("Physician Name", v.docEn, v.docAr, "اسم الطبيب المعالج"),
                                createSplitRow("Position", v.posEn, v.posAr, "المسمى الوظيفي")
                            ]
                        }),

                        new docx.Paragraph({ text: "" }),
                        new docx.Paragraph({ text: "" }),

                        new docx.Table({
                            width: { size: 100, type: docx.WidthType.PERCENTAGE },
                            borders: { top: {style:"none"}, bottom: {style:"none"}, left: {style:"none"}, right: {style:"none"}, insideVertical: {style:"none"}, insideHorizontal: {style:"none"} },
                            rows: [
                                new docx.TableRow({
                                    children: [
                                        new docx.TableCell({
                                            width: { size: 60, type: docx.WidthType.PERCENTAGE },
                                            children: [
                                                new docx.Paragraph({ alignment: docx.AlignmentType.CENTER, children: imgBarcode ? [new docx.ImageRun({ data: imgBarcode, transformation: { width: 80, height: 80 } })] : [new docx.TextRun("")] }),
                                                new docx.Paragraph({ text: "" }),
                                                new docx.Paragraph({ alignment: docx.AlignmentType.CENTER, children: [new docx.TextRun({ text: "للتحقق من بيانات التقرير يرجى التأكد من زيارة موقع منصة صحة الرسمي", bold: true, size: 14 })] }),
                                                new docx.Paragraph({ alignment: docx.AlignmentType.CENTER, children: [new docx.TextRun({ text: "To check the report please visit Seha's official website", bold: true, size: 14 })] }),
                                                new docx.Paragraph({ alignment: docx.AlignmentType.CENTER, children: [new docx.TextRun({ text: "www.seha.sa/#/inquiries/slenquiry", color: "0000FF", underline: {}, bold: true, size: 16 })] }),
                                                new docx.Paragraph({ text: "" }),
                                                new docx.Paragraph({ alignment: docx.AlignmentType.CENTER, children: [new docx.TextRun({ text: timeStr, bold: true, size: 24 })] }),
                                                new docx.Paragraph({ alignment: docx.AlignmentType.CENTER, children: [new docx.TextRun({ text: dateStr, bold: true, size: 24 })] })
                                            ]
                                        }),
                                        new docx.TableCell({
                                            width: { size: 40, type: docx.WidthType.PERCENTAGE },
                                            verticalAlign: docx.VerticalAlign.TOP,
                                            children: [
                                                new docx.Paragraph({ alignment: docx.AlignmentType.CENTER, children: imgHospital ? [new docx.ImageRun({ data: imgHospital, transformation: { width: 100, height: 60 } })] : [new docx.TextRun("")] }),
                                                new docx.Paragraph({ text: "" }),
                                                new docx.Paragraph({ text: "" }),
                                                new docx.Paragraph({ text: "" }),
                                                new docx.Paragraph({ alignment: docx.AlignmentType.CENTER, children: imgNhic ? [new docx.ImageRun({ data: imgNhic, transformation: { width: 130, height: 50 } })] : [new docx.TextRun("")] })
                                            ]
                                        })
                                    ]
                                })
                            ]
                        })
                    ]
                }]
            });

            docx.Packer.toBlob(doc).then((blob) => {
                saveAs(blob, "Sick_Leave_Report.docx");
            }).catch(e => alert("حدث خطأ في تجهيز الملف: " + e.message));
        } catch (error) {
            alert("حدث خطأ غير متوقع: " + error.message);
        }
    }
</script>
</body>
</html>
